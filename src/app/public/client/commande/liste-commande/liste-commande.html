<!-- Header -->
<app-header></app-header>

<!-- Main Content -->
<main class="main-content" *ngIf="jwtToken">
    <div class="container">
        <div class="page-title">
            <h2><i class="fas fa-history"></i> Mes Commandes</h2>
            <span>{{filteredOrders.length}} commande{{filteredOrders.length !== 1 ? 's' : ''}} au total</span>
        </div>

        <!-- Filtres -->
        <div class="filters">
            <button class="filter-btn" [class.active]="currentFilter === 'all'" (click)="setFilter('all')">
                <i class="fas fa-list"></i> Toutes
            </button>
            <button class="filter-btn" [class.active]="currentFilter === 'En attente'"
                (click)="setFilter('En attente')">
                <i class="fas fa-clock"></i> En attente
            </button>
            <button class="filter-btn" [class.active]="currentFilter === 'En préparation'" (click)="setFilter('En préparation')">
                <i class="fas fa-utensils"></i> En préparation
            </button>
            <button class="filter-btn" [class.active]="currentFilter === 'Livrée'" (click)="setFilter('Livrée')">
                <i class="fas fa-check-circle"></i> Livrées
            </button>
            <button class="filter-btn" [class.active]="currentFilter === 'En route'"
                (click)="setFilter('En route')">
                <i class="fas fa-motorcycle"></i> En route
            </button>
            <button class="filter-btn" [class.active]="currentFilter === 'Annulée'" (click)="setFilter('Annulée')">
                <i class="fas fa-times-circle"></i> Annulées
            </button>
            
        </div>

        <!-- Recherche -->
        <div class="search-box">
            <input type="text" placeholder="Rechercher une commande..." [value]="searchTerm" (input)="onSearch($event)">
            <button class="search-btn"><i class="fas fa-search"></i></button>
        </div>

        <!-- Section des commandes -->
        <div class="orders-section">
    <!-- Commandes paginées -->
    <div class="order-card" *ngFor="let order of paginatedOrders">

        <!-- En-tête commande -->
        <div class="order-header">
            <div>
                <div class="order-id">Commande #{{order.numCom}}</div>
                <div class="order-date">
                    <i class="far fa-calendar"></i>
                    Passée le {{ formatDate(order.dateCreation) }}
                </div>
            </div>

            <div class="order-status" [class]="'status-' + order.etat">
                <i [class]="getStatusIcon(order.etat)"></i> 
                {{ getStatusText(order.etat) }}
            </div>
        </div>

        <!-- Produits -->
        <div class="order-details">
            <div class="order-items">
                <div class="order-item" *ngFor="let item of order.produits">
                    <span class="item-name">{{ item.name }}</span>
                    <span class="item-quantity">x{{ item.quantity }}</span>
                    <span class="item-price">{{ formatPrice(item.price) }}</span>
                </div>
            </div>

            <!-- Infos de livraison -->
            <div class="order-info">
                <div>
                    <i [class]="order.typeLivraison === 'Livraison' ? 'fas fa-truck' : 'fas fa-store'"></i>
                    <strong>{{ order.typeLivraison }} :</strong> 
                    {{ order.adresse }}
                </div>
            </div>

            <div class="order-total">
                {{ formatPrice(order.total) }}
            </div>
        </div>

        <!-- Actions -->
        <div class="order-actions">
            <!-- Action commune -->
            <button class="action-btn" (click)="reorder(order)">
                <i class="fas fa-redo"></i> Commander à nouveau
            </button>

            <!-- Actions selon statut -->
            <ng-container [ngSwitch]="order.etat">

                <ng-container *ngSwitchCase="'Livrée'">
                    <button class="action-btn secondary" (click)="viewInvoice(order)">
                        <i class="fas fa-file-invoice"></i> Voir la facture
                    </button>
                    <!-- <button class="action-btn secondary" (click)="rateOrder(order)">
                        <i class="fas fa-star"></i> Noter la commande
                    </button> -->
                </ng-container>

                <ng-container *ngSwitchCase="'En route'">
                    <button class="action-btn" (click)="trackOrder(order)">
                        <i class="fas fa-map-marker-alt"></i> Suivre ma commande
                    </button>
                </ng-container>

                <ng-container *ngSwitchCase="'En préparation'">
                    <button class="action-btn" (click)="trackOrder(order)">
                        <i class="fas fa-clock"></i> Voir le statut
                    </button>
                    <button class="action-btn secondary" (click)="cancelOrder(order)">
                        <i class="fas fa-times"></i> Annuler la commande
                    </button>
                </ng-container>
            </ng-container>

        </div>
    </div>

    <!-- Si aucune commande -->
    <div *ngIf="filteredOrders.length === 0" class="no-orders">
        <i class="fas fa-box-open fa-3x"></i>
        <h3>Aucune commande trouvée</h3>
        <p>Aucune commande ne correspond à vos critères.</p>
        <button class="reset-filters" 
                (click)="setFilter('all'); searchTerm=''; applyFilters()">
            Réinitialiser
        </button>
    </div>
</div>


        <!-- Pagination -->
        <div class="pagination-container" *ngIf="totalPages > 1">
             <!-- <div class="pagination-info">
                Affichage de {{(currentPage - 1) * itemsPerPage + 1}} à
               {{Math.min(currentPage * itemsPerPage, filteredOrders.length)}} 
                sur {{filteredOrders.length}} commandes
            </div> -->

            <div class="pagination">
                <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 1">
                    ‹ Précédent
                </button>

                <button *ngFor="let page of pages" class="page-btn" [class.active]="page === currentPage"
                    (click)="goToPage(page)">
                    {{page}}
                </button>

                <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
                    Suivant ›
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<app-footer></app-footer>